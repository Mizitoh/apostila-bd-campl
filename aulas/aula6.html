<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aula 6 - Leitura de dados</title>
    <link rel="icon" type="image/png" href="./../assets/imagens/caderno.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./../assets/css/style.css" />
  </head>
  <body>
    <div class="container">
      <main class="content">
        <h1>Aula 6 - Leitura de dados</h1>

        <h2>Consultas SELECT</h2>
        <p>
          Iniciamos a leitura dos dados, para consultar dados o comando é o
          <strong>SELECT</strong>, aqui a criatividade é infinita!
        </p>
        <p>
          Existem várias formas e vários comandos para extrair os dados que você
          precisa.
        </p>
        <p>Exemplos de consultas comuns usando nossa base de escola:</p>
        <pre><code class="language-sql">
-- ========================================
-- CONSULTAS ÚTEIS
-- ========================================

-- Dados básicos dos alunos
SELECT * FROM alunos;
select * from matriculas;
SELECT * FROM cursos;
SELECT * FROM professores;
SELECT * FROM sexos;
SELECT * FROM enderecos;
SELECT * FROM telefones;

-- Alias para colunas
SELECT a.nome AS nome_aluno, s.descricao AS sexo FROM alunos a
JOIN sexos s ON a.sexo_id = s.id;

        </code></pre>

        <hr />

        <h2>Conceitos Fundamentais de Consultas SQL</h2>

        <h3>JOIN - Combinando dados de múltiplas tabelas</h3>
        <p>
          JOINs conectam dados de duas ou mais tabelas usando chaves
          estrangeiras. Existem diferentes tipos:
        </p>
        <ul>
          <li>
            <strong>INNER JOIN:</strong> Retorna apenas registros que existem em
            ambas as tabelas
          </li>
          <li>
            <strong>LEFT JOIN:</strong> Retorna todos os registros da tabela
            esquerda, mesmo que não tenham correspondência na direita
          </li>
          <li>
            <strong>RIGHT JOIN:</strong> Retorna todos os registros da tabela
            direita, mesmo que não tenham correspondência na esquerda
          </li>
          <li>
            <strong>FULL OUTER JOIN:</strong> Retorna registros de ambas as
            tabelas, preenchendo com NULL onde não há correspondência
          </li>
        </ul>

        <h3>WHERE - Filtrando registros</h3>
        <p>
          A cláusula WHERE filtra resultados com base em condições específicas.
          Pode usar operadores como =, &gt;, &lt;, &gt;=, &lt;=, !=, AND, OR,
          IN, BETWEEN, LIKE.
        </p>

        <h3>GROUP BY - Agrupando dados</h3>
        <p>
          GROUP BY agrupa registros por uma ou mais colunas e é frequentemente
          usado com funções de agregação como COUNT(), SUM(), AVG(), MAX(),
          MIN(). Usado para gerar resumos e estatísticas.
        </p>

        <h3>HAVING - Filtrando grupos</h3>
        <p>
          HAVING é similar ao WHERE, mas filtra grupos criados pelo GROUP BY,
          não registros individuais. Geralmente é usado com funções de
          agregação.
        </p>

        <h3>ORDER BY - Ordenando resultados</h3>
        <p>
          ORDER BY ordena os resultados em ordem crescente (ASC) ou decrescente
          (DESC). Pode ordenar por múltiplas colunas.
        </p>

        <h3>CASE WHEN - Lógica condicional</h3>
        <p>
          CASE WHEN permite criar condições lógicas dentro de uma consulta,
          retornando diferentes valores baseado em critérios específicos.
        </p>

        <h3>Funções de Agregação</h3>
        <ul>
          <li><strong>COUNT():</strong> Conta quantidade de registros</li>
          <li><strong>SUM():</strong> Soma valores numéricos</li>
          <li><strong>AVG():</strong> Calcula média aritmética</li>
          <li><strong>MAX():</strong> Retorna valor máximo</li>
          <li><strong>MIN():</strong> Retorna valor mínimo</li>
        </ul>

        <hr />

        <h2>Consultas SELECT Avançadas</h2>
        <p>Exemplos de consultas usando recursos avançados do SQL:</p>
        <pre><code class="language-sql">
-- WHERE
SELECT a.nome, m.nota, c.nome as curso
FROM alunos a
JOIN matriculas m ON m.matricula_id_aluno = a.id
JOIN cursos c ON c.id = m.curso_id
WHERE m.nota >= 7;

-- Ver todos os dados de um aluno (igual à tabela original, mas com sexo por extenso)
SELECT 
    a.id as id_ou_matricula,
    a.nome,
    s.descricao as sexo,
    s.pronome,
    e.rua,
    e.numero,
    e.bairro,
    STRING_AGG(DISTINCT t.numero, ', ') as telefones,
    STRING_AGG(DISTINCT c.nome, ', ') as cursos,
    STRING_AGG(DISTINCT p.nome, ', ') as professores,
    AVG(m.nota) as media_notas
FROM alunos a
LEFT JOIN sexos s ON a.sexo_id = s.id
LEFT JOIN enderecos e ON a.id = e.id_aluno
LEFT JOIN telefones t ON a.id = t.id_aluno
LEFT JOIN matriculas m ON a.id = m.matricula_id_aluno
LEFT JOIN cursos c ON m.curso_id = c.id
LEFT JOIN professores p ON c.professor_id = p.id
WHERE a.id = 1
GROUP BY a.id, a.nome, s.descricao, s.pronome, 5, 6, 7;

-- Ver cursos de um aluno com notas e professores
SELECT 
    a.nome as aluno,
    s.descricao as sexo,
    s.pronome,
    c.nome as curso,
    p.nome as professor,
    m.nota
FROM alunos a
JOIN sexos s ON a.sexo_id = s.id
JOIN matriculas m ON a.id = m.matricula_id_aluno
JOIN cursos c ON m.curso_id = c.id
JOIN professores p ON c.professor_id = p.id
WHERE a.id = 3;  -- Sam (não-binário)

-- Ver todos os alunos de um curso com diversidade
SELECT 
    c.nome as curso,
    p.nome as professor,
    a.nome as aluno,
    s.descricao as sexo,
    m.nota
FROM cursos c
JOIN professores p ON c.professor_id = p.id
JOIN matriculas m ON c.id = m.curso_id
JOIN alunos a ON m.matricula_id_aluno = a.id
JOIN sexos s ON a.sexo_id = s.id
WHERE c.nome = 'PostgreSQL Essencial'
ORDER BY m.nota DESC;

-- Ver alunos e seus telefones
SELECT 
    a.nome as aluno,
    t.numero as telefone
FROM alunos a
JOIN telefones t ON a.id = t.id_aluno
ORDER BY a.nome;

-- Média nos cursos
SELECT 
    c.nome as curso,
    COUNT(*) as quantidade_alunos,
    ROUND(AVG(m.nota), 2) as media_notas
FROM cursos c
JOIN matriculas m ON c.id = m.curso_id
JOIN alunos a ON m.matricula_id_aluno = a.id
GROUP BY c.nome
ORDER BY c.nome, quantidade_alunos DESC;

-- CASE WHEN para classificar aprovação
SELECT 
    a.nome,
    m.nota,
    CASE 
        WHEN m.nota >= 7 THEN 'Aprovado'
        ELSE 'Reprovado'
    END as situacao
FROM alunos a
JOIN matriculas m ON m.matricula_id_aluno = a.id;

-- ORDER BY com múltiplas colunas
SELECT a.nome, c.nome as curso, m.nota
FROM alunos a
JOIN matriculas m ON m.matricula_id_aluno = a.id
JOIN cursos c ON c.id = m.curso_id
ORDER BY m.nota DESC, a.nome ASC;

-- GROUP BY com contagem e média
SELECT 
    c.nome as curso,
    COUNT(m.matricula_id_aluno) as total_alunos,
    AVG(m.nota) as media_notas
FROM cursos c
LEFT JOIN matriculas m ON m.curso_id = c.id
GROUP BY c.nome;

-- GROUP BY com HAVING (filtro em grupos)
SELECT 
    c.nome as curso,
    COUNT(m.matricula_id_aluno) as total_alunos,
    AVG(m.nota) as media_notas
FROM cursos c
LEFT JOIN matriculas m ON m.curso_id = c.id
GROUP BY c.nome
HAVING COUNT(m.matricula_id_aluno) > 2 AND AVG(m.nota) >= 7;
        </code></pre>

        <hr />

        <h2>Menu</h2>
        <div class="mt-4">
          <!-- <a href="./aula7.html" class="btn btn-primary">Próxima aula →</a> -->
          <a href="./../index.html" class="btn btn-outline-secondary"
            >← Voltar ao Início</a
          >
          <a href="./../aulas.html" class="btn btn-outline-secondary"
            >← Voltar às aulas por data</a
          >
        </div>
      </main>
    </div>

    <script src="./../assets/js/sidebar.js"></script>
    <script src="./../assets/js/table-of-contents.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
      hljs.highlightAll();
    </script>
  </body>
</html>
